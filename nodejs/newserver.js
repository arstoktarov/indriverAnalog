const db = require('./Modules/db');
const validate = require('validate.js');
const consoleMsg = require('./Modules/consoleMsg');
const wsUserModule = require('./Modules/WSUser');
const Order = require('./Modules/WSOrder');
const functions = require('./Modules/additionalFunctions');
const { app, server } = require('./Loaders/Express');
const { Websocket, wss, rooms } = require('./Loaders/Websocket');
const redis = require('./Loaders/Redis');
const uuid = require('uuid-random/index');

let sockets = new Set();
let orders = new Map();


const models = require('./Models/Models');



wss.on('connection',  function connection(ws) {
    let socket = new wsUserModule.User(ws);
    sockets.add(socket);
    consoleMsg.info('New connection catched. Current clients count: ' + wss.clients.size);

    // socket.ws.ping();
    // socket.isOnline = true;
     let pinger = null;
    //
    // socket.on('pong', function() {
    //     clearTimeout(pinger);
    //     socket.isOnline = true;
    //     pinger = setTimeout(function() {
    //         if (socket.isOnline === false) {
    //             socket.ws.close();
    //         }
    //         else {
    //             socket.isOnline = false;
    //             socket.ws.ping();
    //         }
    //     }, 30000);
    // });

    socket.on('message', function (json) {
        consoleMsg.log("MESSAGE: " + json);
        let data = wsUserModule.User.parseJson(json);
        let constraints = {
            "event": {presence: true},
            "data": {presence:true}
        };
        let errors = validate(data, constraints);

        if (errors !== undefined) {
            socket.send(functions.errorResponse(errors));
            return;
        }

        socket.callEvent(data);
    });

    socket.on('close', function(reason) {
        consoleMsg.log('User ' + ((socket.uuid) ? socket.uuid : 'anon') + ' has disconnected with reasonCode ' + reason);

        socket.rooms.forEach(function(room) {
            rooms.removeElem(room, socket);
        });
        clearTimeout(pinger);
        orders.delete(socket.uuid);
        sockets.delete(socket);
        socket.destroy();
        socket = null;

    });

    //pong from user
    socket.addEventListener("connection", async function(data, eventName) {
        let constraints = {
            "token": {presence: true}
        };
        let errors = validate(data, constraints);
        if (errors !== undefined) {
            socket.send(functions.errorResponse(errors));
            return;
        }

        //let user = await models.User.query().where('token', data['token']).first();
        let user = await models.User.getUserByToken(data['token'], 'technics');
        if (user) {
            socket.user = user;
            socket.send(functions.response(eventName, user));
        }
        else {
            socket.send(functions.errorResponse({message: "User not found"}));
        }
    });

    socket.addEventListener("getMyData", function(data, eventName) {
        socket.send(functions.response(eventName, socket.getData()));
    });

    socket.addEventListener("location", function(data, eventName) {
        let constraints = {
            "lat": {presence: true},
            'long': {presence: true}
        };
        let errors = validate(data, constraints);
        if (errors !== undefined) {
            socket.send(functions.errorResponse(errors));
            return;
        }

        socket.location = data;
    });

    socket.addEventListener("makeOrder", async function(data, eventName) {
        let constraints = {
            'city_id': {presence:true},
            'technic_id': {presence:true},
            'address.title': {presence:true},
            'address.lat': {presence:true},
            'address.long': {presence:true},
            'price': {presence:true},
            'description': {presence:true},
        };
        let errors = validate(data, constraints);
        if (errors !== undefined) {
            socket.send(functions.errorResponse(errors));
            return;
        }

        if (!socket.user) {
            socket.send(functions.errorResponse({message: 'you have no permissions'}));
            return;
        }

        socket.order = {
            executor: null,
            responses: new Set(),
            order: {
                uuid: uuid(),
                city_id: data['city_id'],
                technic_id: data['technic_id'],
                address: data['address']['title'],
                lat: data['address']['lat'],
                long: data['address']['long'],
                price: data['price'],
                description: data['description'],
                created_at: Date.now(),
                updated_at: Date.now(),
                socket: {
                    socket_id: socket.uuid,
                    user: socket.user
                },
            }
        };


        orders.set(socket.uuid, socket.order);

        socket.send(functions.response('makeOrder', socket.order));
    });

    socket.addEventListener("myOrder", async function(data, eventName) {
        socket.send(functions.response("myOrder", orders.get(socket.uuid)));
    });

    socket.addEventListener("respondOrder", async function(data, eventName) {
        let constraints = {
            'order_uuid': {presence:true},
        };
        let errors = validate(data, constraints);
        if (errors !== undefined) {
            socket.send(functions.errorResponse(errors));
            return;
        }

        let order = Array.from(orders.values()).find((order) => {
            return order.order.uuid === data['order_uuid']
        });

        consoleMsg.log(JSON.stringify(order, null, 4));

        let orderOwner = sockets[order.socket.socket_id];
        if (orderOwner) {
            orderOwner.send(functions.response('newResponse', socket.user));
        }
    });

    socket.addEventListener("closeOrder", async function(data, eventName) {
        let constraints = {
            'order': {presence:true}
        };
        let errors = validate(data, constraints);
        if (errors !== undefined) {
            socket.send(functions.errorResponse(errors));
            return;
        }
    });

    socket.addEventListener("declineOrder", async function(data, eventName) {});

    socket.interval("orders", function() {
        if (socket.user && socket.user.technics && socket.user.type === 2) {
            let personalOrders = Array.from(orders.values())
                .filter(function (order) {
                    return socket.user.technics.find(function (technic) {
                        return technic.id === order.order.technic_id
                    });
                })
                .map(order => order.data);
            socket.send(functions.response('orders', personalOrders));
        }
    }, 10000);


});


setInterval(function() {
    consoleMsg.log("sockets: " + JSON.stringify(functions.pluck(sockets, 'uuid')));
    consoleMsg.log("rooms: " + Array.from(rooms.getWsRooms().keys()));
    consoleMsg.log("orders: " + Array.from(orders.keys()));
}, 10000);

wss.on('close', function() {
    consoleMsg.log("Server disconnected: " + wss.clients.size);
});

